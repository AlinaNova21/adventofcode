package day17

import (
	"fmt"

	"github.com/ags131/adventofcode/2019/aoc"
	"github.com/ags131/adventofcode/2019/aoc/grid"
	"github.com/ags131/adventofcode/2019/aoc/intcode"
	"github.com/ags131/adventofcode/2019/aoc/point"
)

// Run runs this day
func Run(input *aoc.Input) aoc.Output {
	prog := intcode.ReadInput(input)
	m := intcode.NewMachine(prog)
	fmt.Println("")
	g := grid.New(100, 100)
	g.Do(func(p point.Point2D, _ interface{}) {
		g.Set(p, 0)
	})
	pos := point.Point2D{}
	for c := range m.Output {
		if c == 10 {
			pos.X = 0
			pos.Y++
		} else {
			g.Set(pos, c)
			pos.X++
		}
		fmt.Print(string(c))
	}
	part1 := 0
	g.Do(func(p point.Point2D, v interface{}) {
		neighbors := []point.Point2D{
			{X: p.X, Y: p.Y - 1},
			{X: p.X, Y: p.Y + 1},
			{X: p.X - 1, Y: p.Y},
			{X: p.X + 1, Y: p.Y},
		}
		if v.(int) == '#' {
			inter := true
			for _, n := range neighbors {
				if n.X == g.Width() || n.X < 0 || n.Y == g.Height() || n.Y < 0 {
					inter = false
					continue
				}
				inter = inter && g.Get(n).(int) == '#'
			}
			if inter {
				part1 += p.X * p.Y
			}
		}
	})
	fmt.Println("====== P2 ======")
	part2 := 0
	prog[0] = 2
	m = intcode.NewMachine(prog)
	oif := m.InputFunc
	m.InputFunc = func() int {
		v := oif()
		fmt.Print(string(v))
		return v
	}
	m.OutputFunc = func(v int) {
		if v > 255 {
			part2 = v
			return
		}
		fmt.Print(string(v))
	}
	for _, act := range actions {
		for _, c := range act {
			m.Input <- int(c)
		}
	}
	fmt.Println("")
	for v := range m.Output {
		fmt.Print(v)
	}
	return aoc.Output{Part1: part1, Part2: part2}
}

var actions = []string{
	//=================//
	"A,A,B,C,B,C,B,C,B,A\n",
	"R,6,L,12,R,6\n",      // A
	"L,12,R,6,L,8,L,12\n", // B
	"R,12,L,10,L,10\n",    // C
	"n\n",
}

/*
R,6,L,12,R,6,
R,6,L,12,R,6,
L,12,R,6,L,8,L,12,
R,12,L,10,L,10,
L,12,R,6,L,8,L,12,
R,12,L,10,L,10,
L,12,R,6,L,8,L,12,
R,12,L,10,L,10,
L,12,R,6,L,8,L,12,
R,6,L,12,R,6,

..............................................###########......
..............................................#.........#......
..............................................#.........#......
..............................................#.........#......
......#######.................................#.........#......
......#.....#.................................#.........#......
......#.....#.........#.......................#.........#......
......#.....#.........#.......................#.........#......
......#.....#.........#.......................#.........#......
......#.....#.........#.......................#.........#......
......#.....#############...................#############......
......#...............#.#...................#.#................
......#...............#############.....#######................
......#.................#.........#.....#...#..................
......#.................#.........#.....#...#..................
......#.................#.........#.....#...#..................
^######.................#############...#.#########............
..................................#.#...#.#.#.....#............
..................................#############...#............
....................................#...#.#.#.#...#............
....................................#...#############..........
....................................#.....#.#.#...#.#..........
....................................#########.#...#############
..........................................#...#.....#.........#
..........................................#...#.....#.........#
..........................................#...#.....#.........#
........................................#######.....#.........#
........................................#.#.........#.........#
..............................#############.........#.........#
..............................#.........#...........#.........#
..............................#.........#...........#.........#
..............................#.........#...........#.........#
..............................#.........#...........###########
..............................#.........#......................
..............................#.........#......................
..............................#.........#......................
..............................#.........#......................
..............................#.........#......................
..............................###########......................
*/
